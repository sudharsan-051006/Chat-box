{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Room</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ================= RESET ================= */
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, -apple-system;
}

/* ================= THEME ================= */
body.dark-mode {
  background: #343541;
  color: #ececf1;
}

body.light-mode {
  background: #f8f9fa;
  color: #212529;
}

/* ================= LAYOUT ================= */
.app {
  display: flex;
  height: 100dvh; /* mobile-safe */
}

/* ================= SIDEBAR ================= */
.sidebar {
  width: 260px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  background: #202123;
  color: #ececf1;
}

body.light-mode .sidebar {
  background: #ffffff;
  color: #212529;
  border-right: 1px solid #ddd;
}

/* ================= CHAT ================= */
.chat {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.chat-header {
  padding: 12px 16px;
  font-weight: 600;
  border-bottom: 1px solid #444;
}

body.light-mode .chat-header {
  border-color: #ddd;
}

.chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px 0;
  min-height: 0;
}

/* ================= MESSAGE CONTAINER ================= */
.chat-container {
  max-width: 760px;
  margin: auto;
  padding: 0 12px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
}

/* ================= MESSAGES ================= */
.message {
  padding: 10px 14px;
  width: fit-content;
  max-width: 75%;
  word-wrap: break-word;
}

/* YOU â†’ LEFT */
.message.me {
  align-self: flex-start;
  background: #0d6efd;
  color: white;
  border-radius: 6px 16px 16px 16px;
}

/* OTHERS â†’ RIGHT */
.message.other {
  align-self: flex-end;
  background: #444654;
  color: #ececf1;
  border-radius: 16px 6px 16px 16px;
}

body.light-mode .message.me {
  background: #dcf8c6;
  color: #000;
}

body.light-mode .message.other {
  background: #ffffff;
  color: #000;
}

/* SYSTEM MESSAGE */
.system {
  align-self: center;
  opacity: 0.7;
  font-style: italic;
  font-size: 0.9rem;
}

/* TIME */
.msg-time {
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 4px;
  text-align: right;
}

/* ================= INPUT ================= */
.chat-input {
  position: sticky;
  bottom: 14px; /* lifted up */
  padding: 10px;
  background: inherit;
  border-top: 1px solid #444;
}

body.light-mode .chat-input {
  border-color: #ddd;
}

.chat-input form {
  max-width: 760px;
  margin: auto;
  display: flex;
  gap: 8px;
}

textarea {
  resize: none;
  padding: 10px;
  border-radius: 6px;
  flex: 1;
}

button.send {
  background: #0d6efd;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 0 18px;
}

/* ================= MOBILE FIX ================= */
@media (max-width: 768px) {
  .sidebar {
    display: none;
  }

  .chat-container {
    max-width: 100%;
  }

  .message {
    max-width: 85%;
    font-size: 0.95rem;
  }

  .chat-input {
    bottom: 24px;
    padding-bottom: env(safe-area-inset-bottom);
  }

  textarea {
    font-size: 16px; /* prevent iOS zoom */
  }
}
</style>
</head>

<body class="dark-mode">

<div class="app">

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">

  <h6>Room</h6>
  <div class="mb-2">{{ room_name }}</div>

  {% if request.user == room.created_by %}
  <button id="lock-room-btn" class="btn btn-sm btn-warning mb-2">
    {% if room.is_locked %} ðŸ”“ Unlock Room {% else %} ðŸ”’ Lock Room {% endif %}
  </button>
  {% endif %}

  <button id="clear-cache-btn" class="btn btn-sm btn-outline-warning mb-2">
    ðŸ§¹ Clear Chat Cache
  </button>

  <button id="toggle-theme-btn" class="btn btn-sm btn-secondary mb-2">
    ðŸŒ™ Toggle Theme
  </button>

  <a href="/password_change/" class="btn btn-sm btn-outline-secondary mb-2">
    ðŸ”‘ Change Password
  </a>

  <button id="leave-room-btn" class="btn btn-sm btn-outline-danger mb-2">
    ðŸšª Leave Room
  </button>

  <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-secondary">
    Logout
  </a>

  <hr>

  <h6 id="online-users-title">Online Users (0)</h6>
  <ul id="online-users" class="list-group mb-2"></ul>

  <button id="enable-all" class="btn btn-sm btn-success mb-1">Enable All</button>
  <button id="disable-all" class="btn btn-sm btn-danger">Disable All</button>
</div>

<!-- ================= CHAT ================= -->
<div class="chat">

  <div class="chat-header">
    {{ room_name }} {% if room.is_locked %} ðŸ”’ {% endif %}
  </div>

  <div class="chat-body">
    <div id="chat-messages" class="chat-container"></div>
  </div>

  <div class="chat-input">
    <form id="chat-form">
      {% csrf_token %}
      <textarea id="chat-message-input" rows="1" placeholder="Type a messageâ€¦"></textarea>
      <button class="send">Send</button>
    </form>
  </div>

</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const roomName = "{{ room_name }}";
  const currentUser = "{{ request.user.username }}";

  const ws = new WebSocket(
    (location.protocol === "https:" ? "wss" : "ws") +
    "://" + location.host + "/ws/chat/" + roomName + "/"
  );

  const chatMessages = document.getElementById("chat-messages");
  const input = document.getElementById("chat-message-input");
  const form = document.getElementById("chat-form");

  let visibleUsers = new Set();
  let currentOnlineUsers = [];

  /* ================= CACHE ================= */
  function cacheMessage(data) {
    const key = "chat_" + roomName;
    const msgs = JSON.parse(localStorage.getItem(key) || "[]");
    msgs.push(data);
    localStorage.setItem(key, JSON.stringify(msgs.slice(-200)));
  }

  function loadCachedMessages() {
    chatMessages.innerHTML = "";
    const cached = JSON.parse(localStorage.getItem("chat_" + roomName) || "[]");
    cached.forEach(renderMessage);
  }

  /* ================= RENDER ================= */
  function renderMessage(data) {
    if (!data || !data.user || !data.message) return;

    if (
      data.user !== "System" &&
      visibleUsers.size > 0 &&
      !visibleUsers.has(data.user)
    ) return;

    const div = document.createElement("div");

    if (data.user === "System") {
      div.className = "system";
      div.textContent = data.message;
    } else {
      const isMe =
        data.user.trim().toLowerCase() ===
        currentUser.trim().toLowerCase();

      div.className = "message " + (isMe ? "me" : "other");

      const text = document.createElement("div");
      text.textContent = isMe
        ? data.message
        : data.user + ": " + data.message;

      const time = document.createElement("div");
      time.className = "msg-time";
      time.textContent = data.time;

      div.append(text, time);
    }

    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  /* ================= WEBSOCKET ================= */
  ws.onmessage = function (e) {
    const raw = JSON.parse(e.data);
    const now = new Date();
    const time =
      now.getHours().toString().padStart(2, "0") + ":" +
      now.getMinutes().toString().padStart(2, "0");

    if (raw.type === "system") {
      const data = { user: "System", message: raw.text, time };
      cacheMessage(data);
      renderMessage(data);
      return;
    }

    if (raw.type === "user_list") {
      currentOnlineUsers = raw.users;
      const ul = document.getElementById("online-users");
      const title = document.getElementById("online-users-title");
      ul.innerHTML = "";

      raw.users.forEach(u => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between";

        const name = document.createElement("span");
        name.textContent = u;

        const btn = document.createElement("button");
        const enabled = visibleUsers.size === 0 || visibleUsers.has(u);
        btn.textContent = enabled ? "Disable" : "Enable";
        btn.className = "btn btn-sm " + (enabled ? "btn-danger" : "btn-success");

        btn.onclick = () => {
          if (visibleUsers.size === 0)
            raw.users.forEach(x => visibleUsers.add(x));

          visibleUsers.has(u)
            ? visibleUsers.delete(u)
            : visibleUsers.add(u);

          loadCachedMessages();
        };

        li.append(name, btn);
        ul.appendChild(li);
      });

      title.textContent = "Online Users (" + raw.users.length + ")";
      return;
    }

    if (raw.user && raw.message) {
      const data = { user: raw.user, message: raw.message, time };
      cacheMessage(data);
      renderMessage(data);
    }
  };

  loadCachedMessages();

  /* ================= SEND ================= */
  form.onsubmit = e => {
    e.preventDefault();
    if (input.value.trim()) {
      ws.send(JSON.stringify({ message: input.value }));
      input.value = "";
    }
  };

  /* ================= CONTROLS ================= */
  document.getElementById("enable-all").onclick = () => {
    visibleUsers.clear();
    loadCachedMessages();
  };

  document.getElementById("disable-all").onclick = () => {
    visibleUsers.clear();
    visibleUsers.add(currentUser);
    loadCachedMessages();
  };

  document.getElementById("clear-cache-btn").onclick = () => {
    localStorage.removeItem("chat_" + roomName);
    chatMessages.innerHTML = "";
  };

  document.getElementById("leave-room-btn").onclick = () => {
    ws.close();
    window.location.href = "/";
  };

  document.getElementById("lock-room-btn")?.addEventListener("click", () => {
    fetch("/room/" + roomName + "/toggle-lock/", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ allowed_users: currentOnlineUsers })
    }).then(() => location.reload());
  });

  const themeBtn = document.getElementById("toggle-theme-btn");
  themeBtn.onclick = () => {
    document.body.classList.toggle("dark-mode");
    document.body.classList.toggle("light-mode");
  };

});
</script>

</body>
</html>
