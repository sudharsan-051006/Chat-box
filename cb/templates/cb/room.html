{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ===== RESET ===== */
html, body {
  height: 100%;
  margin: 0;
  background: #343541;
  color: #ececf1;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}

/* ===== MAIN LAYOUT ===== */
.app {
  display: flex;
  height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: 260px;
  background: #202123;
  border-right: 1px solid #444;
  display: flex;
  flex-direction: column;
  padding: 12px;
}

.sidebar h6 {
  color: #aaa;
  font-size: 0.75rem;
  margin-bottom: 10px;
}

.sidebar a, .sidebar button {
  background: transparent;
  color: #ececf1;
  border: none;
  text-align: left;
  padding: 8px 10px;
  border-radius: 6px;
  width: 100%;
}

.sidebar a:hover,
.sidebar button:hover {
  background: #343541;
}

.chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 12px 16px;
  border-bottom: 1px solid #444;
  background: #343541;
  font-weight: 600;
}

.chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px 0;
}

.chat-container {
  max-width: 760px;
  margin: auto;
  padding: 0 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.message {
  padding: 12px 16px;
  border-radius: 8px;
  white-space: pre-wrap;
  word-break: break-word;
}

.me {
  align-self: flex-end;
  background: #0d6efd;
  color: #fff;
}

.other {
  align-self: flex-start;
  background: #444654;
}

.system {
  text-align: center;
  opacity: 0.7;
}

.chat-input {
  border-top: 1px solid #444;
  padding: 16px;
  background: #343541;
}

.chat-input form {
  max-width: 760px;
  margin: auto;
  display: flex;
  gap: 10px;
}

textarea {
  resize: none;
  background: #40414f;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 10px;
}

textarea:focus { outline: none; }

button.send {
  background: #0d6efd;
  border: none;
  padding: 0 20px;
  border-radius: 6px;
  color: white;
}
</style>
</head>

<body>

<div class="app">

  <div class="sidebar">
    <h6>ROOM</h6>
    <div class="mb-2">{{ room_name }}</div>

    <h6>ACTIONS</h6>

    {% if request.user == room.created_by %}
    <button id="lock-toggle-btn">
      {% if room.is_locked %} ðŸ”“ Unlock Room {% else %} ðŸ”’ Lock Room {% endif %}
    </button>
    {% endif %}

    <hr class="border-secondary">

    <a href="/password_change/">ðŸ”‘ Change Password</a>
    <a href="{% url 'logout' %}">ðŸšª Logout</a>
  </div>

  <!-- CHAT -->
  <div class="chat">

    <div class="chat-header">
      {{ room_name }} {% if room.is_locked %} ðŸ”’ {% endif %}
    </div>

    <div class="chat-body">
      <div id="chat-messages" class="chat-container"></div>
    </div>

    <div class="chat-input">
      <form id="chat-form">
        {% csrf_token %}
        <textarea id="chat-message-input" rows="1" placeholder="Send a message..."></textarea>
        <button class="send" type="submit">Send</button>
      </form>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const roomName = "{{ room_name }}";
  const ws_scheme = location.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(
    ws_scheme + "://" + location.host + "/ws/chat/" + roomName + "/"
  );

  const chatMessages = document.getElementById("chat-messages");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-message-input");
  const currentUser = "{{ request.user.username }}";

  function appendMessage(data) {
    const div = document.createElement("div");

    if (data.user === "System") {
      div.className = "system";
      div.textContent = data.message;
    } else {
      const isMe = data.user === currentUser;
      div.className = "message " + (isMe ? "me" : "other");
      div.textContent = isMe ? data.message : `${data.user}: ${data.message}`;
    }

    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  chatSocket.onmessage = e => appendMessage(JSON.parse(e.data));

  form.addEventListener("submit", e => {
    e.preventDefault();
    if (input.value.trim()) {
      chatSocket.send(JSON.stringify({ message: input.value }));
      input.value = "";
    }
  });
});
</script>

</body>
</html>
