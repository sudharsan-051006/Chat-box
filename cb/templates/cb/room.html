{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat Room</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ================= RESET ================= */
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}

/* ================= DARK MODE ================= */
body.dark-mode {
  background: #343541;
  color: #ececf1;
}

body.dark-mode .sidebar {
  background: #202123;
  border-right: 1px solid #444;
}

body.dark-mode .chat-header,
body.dark-mode .chat-input {
  background: #343541;
  border-color: #444;
}

body.dark-mode .message.me {
  background: #0d6efd;
  color: white;
  border-radius: 16px 16px 4px 16px;
}

body.dark-mode .message.other {
  background: #444654;
  color: #ececf1;
  border-radius: 16px 16px 16px 4px;
}

body.dark-mode textarea {
  background: #40414f;
  color: white;
}

body.dark-mode #online-users li {
  background: #2f2f2f;
  color: white;
}

/* ================= LIGHT MODE ================= */
body.light-mode {
  background: #f8f9fa;
  color: #212529;
}

body.light-mode .sidebar {
  background: #ffffff;
  border-right: 1px solid #ddd;
}

body.light-mode .chat-header,
body.light-mode .chat-input {
  background: #ffffff;
  border-color: #ddd;
}

body.light-mode .message.me {
  background: #0d6efd;
  color: white;
  border-radius: 16px 16px 4px 16px;
}

body.light-mode .message.other {
  background: #e9ecef;
  color: #212529;
  border-radius: 16px 16px 16px 4px;
}

body.light-mode textarea {
  background: #ffffff;
  color: #212529;
  border: 1px solid #ced4da;
}

body.light-mode #online-users li {
  background: #f1f3f5;
  color: #212529;
}

/* ================= LAYOUT ================= */
.app {
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 260px;
  padding: 12px;
  display: flex;
  flex-direction: column;
}

.sidebar h6 {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-bottom: 6px;
}

.chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 12px 16px;
  font-weight: 600;
  border-bottom: 1px solid;
}

.chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px 0;
}

.chat-container {
  max-width: 760px;
  margin: auto;
  padding: 0 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.message {
  padding: 12px 16px;
  max-width: 75%;
  white-space: pre-wrap;
  word-break: break-word;
}

.message.me {
  align-self: flex-end;
}

.message.other {
  align-self: flex-start;
}

.msg-time {
  font-size: 0.7rem;
  opacity: 0.7;
  text-align: right;
  margin-top: 4px;
}

.system {
  text-align: center;
  opacity: 0.7;
  font-style: italic;
}

.chat-input {
  padding: 16px;
  border-top: 1px solid;
}

.chat-input form {
  max-width: 760px;
  margin: auto;
  display: flex;
  gap: 10px;
}

textarea {
  resize: none;
  border-radius: 6px;
  padding: 10px;
  flex: 1;
}

textarea:focus { outline: none; }

button.send {
  background: #0d6efd;
  border: none;
  border-radius: 6px;
  color: white;
  padding: 0 20px;
}
</style>
</head>

<body class="dark-mode">

<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar">

    <h6>ROOM</h6>
    <div class="mb-2">{{ room_name }}</div>

    <a href="/password_change/" class="btn btn-sm btn-outline-secondary mb-2">
      ðŸ”‘ Change Password
    </a>

    <hr>

    <h6 id="online-users-title">Online Users (0)</h6>
    <ul id="online-users" class="list-group mb-2"></ul>

    <button id="enable-all" class="btn btn-sm btn-success mb-1">Enable All</button>
    <button id="disable-all" class="btn btn-sm btn-danger mb-2">Disable All</button>

    <hr>

    <button id="toggle-theme-btn" class="btn btn-sm btn-secondary mb-2">
      ðŸŒ™ Night Mode
    </button>

    <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-secondary">
      ðŸšª Logout
    </a>

  </div>

  <!-- CHAT -->
  <div class="chat">

    <div class="chat-header">
      {{ room_name }} {% if room.is_locked %} ðŸ”’ {% endif %}
    </div>

    <div class="chat-body">
      <div id="chat-messages" class="chat-container"></div>
    </div>

    <div class="chat-input">
      <form id="chat-form">
        {% csrf_token %}
        <textarea id="chat-message-input" rows="1" placeholder="Send a message..."></textarea>
        <button class="send" type="submit">Send</button>
      </form>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const roomName = "{{ room_name }}";
  const ws_scheme = location.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(ws_scheme + "://" + location.host + "/ws/chat/" + roomName + "/");

  const chatMessages = document.getElementById("chat-messages");
  const chatForm = document.getElementById("chat-form");
  const inputField = document.getElementById("chat-message-input");
  const currentUser = "{{ request.user.username }}";

  let visibleUsers = new Set();

  function appendMessage(data) {
    if (data.user !== "System" && visibleUsers.size > 0 && !visibleUsers.has(data.user)) return;

    const msg = document.createElement("div");

    if (data.user === "System") {
      msg.className = "system";
      msg.textContent = data.message;
    } else {
      const isMe = data.user === currentUser;
      msg.className = "message " + (isMe ? "me" : "other");

      const text = document.createElement("div");
      text.textContent = isMe ? data.message : `${data.user}: ${data.message}`;

      const time = document.createElement("div");
      time.className = "msg-time";
      time.textContent = data.time || "";

      msg.appendChild(text);
      msg.appendChild(time);
    }

    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  chatSocket.onmessage = e => {
    const data = JSON.parse(e.data);

    const now = new Date();
    data.time =
      now.getHours().toString().padStart(2, "0") + ":" +
      now.getMinutes().toString().padStart(2, "0");

    if (data.type === "user_list") {
      const ul = document.getElementById("online-users");
      const title = document.getElementById("online-users-title");
      ul.innerHTML = "";

      data.users.forEach(u => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        const span = document.createElement("span");
        span.textContent = u;

        const btn = document.createElement("button");
        let enabled = visibleUsers.size === 0 || visibleUsers.has(u);
        btn.textContent = enabled ? "Disable" : "Enable";
        btn.className = "btn btn-sm " + (enabled ? "btn-danger" : "btn-success");

        btn.onclick = () => {
          if (visibleUsers.size === 0) data.users.forEach(x => visibleUsers.add(x));
          visibleUsers.has(u) ? visibleUsers.delete(u) : visibleUsers.add(u);
          chatMessages.innerHTML = "";
        };

        li.append(span, btn);
        ul.appendChild(li);
      });

      title.textContent = `Online Users (${data.users.length})`;
      return;
    }

    appendMessage(data);
  };

  chatForm.onsubmit = e => {
    e.preventDefault();
    if (inputField.value.trim()) {
      chatSocket.send(JSON.stringify({ message: inputField.value }));
      inputField.value = "";
    }
  };

  document.getElementById("enable-all").onclick = () => {
    visibleUsers.clear();
    chatMessages.innerHTML = "";
  };

  document.getElementById("disable-all").onclick = () => {
    visibleUsers.clear();
    visibleUsers.add(currentUser);
    chatMessages.innerHTML = "";
  };

  const themeBtn = document.getElementById("toggle-theme-btn");
  const savedTheme = localStorage.getItem("theme") || "dark-mode";
  document.body.className = savedTheme;
  themeBtn.textContent = savedTheme === "dark-mode" ? "ðŸŒž Light Mode" : "ðŸŒ™ Night Mode";

  themeBtn.onclick = () => {
    document.body.classList.toggle("dark-mode");
    document.body.classList.toggle("light-mode");
    const dark = document.body.classList.contains("dark-mode");
    themeBtn.textContent = dark ? "ðŸŒž Light Mode" : "ðŸŒ™ Night Mode";
    localStorage.setItem("theme", dark ? "dark-mode" : "light-mode");
  };

});
</script>

</body>
</html>
