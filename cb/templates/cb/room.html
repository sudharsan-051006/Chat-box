{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Room</title>

  <!-- Bootstrap + FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.1/css/all.css">

<style>
/* DARK THEME */
body.dark-mode {
  background: rgb(69, 68, 68);
}
body.dark-mode #chat-messages {
  background: black;
  color: white;
}
body.dark-mode .system { color: #aaa; }

/* LIGHT THEME */
body.light-mode {
  background: #f8f9fa;
}
body.light-mode #chat-messages {
  background: white;
  color: black;
}
body.light-mode .system { color: #666; }

/* Chat container */
#chat-messages {
  height: 65vh;
  overflow-y: auto;
  padding: 2rem 1rem 1rem 1rem;
  border-radius: .5rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
}

/* Message bubble */
.message {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 0.6rem 1rem;
  border-radius: 1rem;
  white-space: pre-wrap;
  word-break: break-word;
  background-clip: padding-box;
  font-family: "Courier New", monospace;
  max-width: 75%;
}

/* Your messages */
.me {
  align-self: flex-end;
  background: linear-gradient(135deg, #007bff, #00b4ff);
  color: #fff;
  border-radius: 1rem 1rem 0 1rem;
}
.other {
  background: #e9ecef;
  color: #212529;
  border-radius: 1rem 1rem 1rem 0;
  align-self: flex-end;
}

/* Timestamp */
.message-time {
  display: block;
  font-size: 0.75rem;
  color: rgba(255,255,255,0.8);
  margin-top: 4px;
  text-align: right;
}
.other .message-time {
  color: rgba(0, 0, 0, 0.5);
}

.system {
  align-self: center;
  font-style: italic;
  padding: 0.4rem 1rem;
}
</style>
</head>

<body class="dark-mode">
<div class="container my-4 position-relative">

  <!-- Dashboard -->
  <div class="dropdown position-absolute" style="top:10px; right:10px; z-index:15;">
    <button class="btn btn-sm dropdown-toggle" type="button"
            id="settingsDropdown" data-bs-toggle="dropdown"
            style="color: turquoise;background-color: #666;" aria-expanded="false">
      <i class="fa-solid fa-table-columns"></i> Dashboard
    </button>

    <ul class="dropdown-menu dropdown-menu-end">
      <li><a class="dropdown-item" href="/password_change/">Change Password</a></li>
      {% if request.user.username == room.created_by.username %}
      <li>
        <button id="lock-toggle-btn" class="dropdown-item text-warning" data-room="{{ room.name }}">
          {% if room.is_locked %} üîì Unlock Room {% else %} üîí Lock Room {% endif %}
        </button>
      </li>
      {% endif %}
      <li><button class="dropdown-item" id="toggle-theme-btn">üåô Night Mode</button></li>
      <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
      <li>
        <button class="dropdown-item" type="button"
                data-bs-toggle="offcanvas" data-bs-target="#offcanvasUsers">
          Online Users
        </button>
      </li>
      <li><button class="dropdown-item text-danger" id="leave-room-btn">üö™ Leave Room</button></li>
    </ul>
  </div>

  <br><br><br>

  <h3 style="color: #e9ecef;" class="btn btn-primary">{{ room_name }} {% if room.is_locked %} ‚õìÔ∏è {% endif %}</h3>

  <!-- Chat Area -->
  <div id="chat-messages" class="position-relative"></div>

  <!-- Input -->
  <form id="chat-form" class="mt-3 d-flex">
    {% csrf_token %}
    <textarea id="chat-message-input" rows="2" class="form-control me-2"
              placeholder="Type a message..." autocomplete="off"></textarea>
    <button class="btn btn-primary" id="chat-message-submit" type="submit">Send</button>
  </form>
</div>

<!-- Sidebar: Online users -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasUsers">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="online-users-title">Online Users (0)</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <ul id="online-users" class="list-group"></ul>

    <hr>

    <!-- Global Settings -->
    <button id="enable-all" class="btn btn-success w-100 mb-2">Enable All</button>
    <button id="disable-all" class="btn btn-danger w-100">Disable All</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const roomName = "{{ room_name }}";
  const ws_scheme = location.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(ws_scheme + '://' + location.host + '/ws/chat/' + roomName + '/');

  const chatMessages = document.getElementById("chat-messages");
  const chatForm = document.getElementById("chat-form");
  const inputField = document.getElementById("chat-message-input");
  const currentUser = "{{ request.user.username }}";

  /* --------------------------------------------------
     USER MESSAGE FILTER SYSTEM
     -------------------------------------------------- */

  // Empty set => show all users
  let visibleUsers = new Set();

  function reloadMessages() {
    chatMessages.innerHTML = "";
    const cached = JSON.parse(localStorage.getItem("chat_" + roomName) || "[]");
    cached.forEach(m => appendMessage(m, false));
  }

  /* --------------------------------------------------
     CACHE FUNCTIONS
     -------------------------------------------------- */
  function loadCachedMessages() {
    const cached = localStorage.getItem("chat_" + roomName);
    if (!cached) return;
    try {
      const msgs = JSON.parse(cached);
      msgs.forEach(data => appendMessage(data, false));
    } catch (e) {}
  }

  function saveMessageToCache(data) {
    const key = "chat_" + roomName;
    let msgs = JSON.parse(localStorage.getItem(key) || "[]");
    msgs.push(data);
    if (msgs.length > 100) msgs = msgs.slice(-100);
    localStorage.setItem(key, JSON.stringify(msgs));
  }

  /* --------------------------------------------------
     APPEND MESSAGE WITH FILTERING
     -------------------------------------------------- */
  function appendMessage(data, animate = true) {

    // FILTER: hide if disabled
    if (data.user !== "System") {
      if (visibleUsers.size > 0 && !visibleUsers.has(data.user)) {
        return;
      }
    }

    const msg = document.createElement("div");
    const isMe = data.user.trim().toLowerCase() === currentUser.trim().toLowerCase();

    if (data.user === "System") {
      msg.className = "system";
      msg.textContent = `${data.message} (${data.time || ''})`;
    } else {
      msg.className = isMe ? "message me" : "message other";

      const textSpan = document.createElement("span");
      textSpan.textContent = isMe ? data.message : `${data.user}:\n${data.message}`;

      const timeSpan = document.createElement("span");
      timeSpan.className = "message-time";
      timeSpan.textContent = data.time || "";

      msg.appendChild(textSpan);
      msg.appendChild(timeSpan);
    }

    if (!animate) msg.style.animation = "none";

    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  /* Load cached messages */
  loadCachedMessages();

  /* --------------------------------------------------
     HANDLE INCOMING WEBSOCKET MESSAGE
     -------------------------------------------------- */
  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const now = new Date();
    data.time = now.getHours().toString().padStart(2, '0') 
                + ":" + now.getMinutes().toString().padStart(2, '0');

    if (data.type === "user_list") {
      const onlineUsers = document.getElementById("online-users");
      const onlineUsersTitle = document.getElementById("online-users-title");

      onlineUsers.innerHTML = "";

      data.users.forEach(u => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        const span = document.createElement("span");
        span.textContent = u;

        const btn = document.createElement("button");
        btn.className = "btn btn-sm";

        let enabled = (visibleUsers.size === 0 || visibleUsers.has(u));
        btn.textContent = enabled ? "Disable" : "Enable";
        btn.classList.add(enabled ? "btn-danger" : "btn-success");

        btn.addEventListener("click", () => {
          if (visibleUsers.size === 0) {
            data.users.forEach(usr => visibleUsers.add(usr));
          }

          if (visibleUsers.has(u)) visibleUsers.delete(u);
          else visibleUsers.add(u);

          btn.textContent = visibleUsers.has(u) ? "Disable" : "Enable";
          btn.className = "btn btn-sm " + (visibleUsers.has(u) ? "btn-danger" : "btn-success");

          reloadMessages();
        });

        li.appendChild(span);
        li.appendChild(btn);
        onlineUsers.appendChild(li);
      });

      onlineUsersTitle.textContent = `Online Users (${data.users.length})`;
      return;
    }

    appendMessage(data, true);
    saveMessageToCache(data);
  };

  /* --------------------------------------------------
     SEND USER MESSAGE
     -------------------------------------------------- */
  chatForm.addEventListener("submit", function(e) {
    e.preventDefault();
    if (inputField.value.trim()) {
      chatSocket.send(JSON.stringify({ "message": inputField.value }));
      inputField.value = "";
    }
  });

  /* Leave room */
  document.getElementById("leave-room-btn")?.addEventListener("click", () => {
    chatSocket.close();
    window.location.href = "/";
  });

  /* THEME TOGGLE */
  const themeBtn = document.getElementById("toggle-theme-btn");

  document.body.className = localStorage.getItem("theme") || "dark-mode";
  themeBtn.textContent = document.body.classList.contains("dark-mode") ? "üåû Light Mode" : "üåô Night Mode";

  themeBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    document.body.classList.toggle("light-mode");
    const dark = document.body.classList.contains("dark-mode");
    themeBtn.textContent = dark ? "üåû Light Mode" : "üåô Night Mode";
    localStorage.setItem("theme", dark ? "dark-mode" : "light-mode");
  });


  /* --------------------------------------------------
     GLOBAL ENABLE / DISABLE ALL
     -------------------------------------------------- */
  document.getElementById("enable-all").addEventListener("click", () => {
    visibleUsers.clear(); // empty => show everyone
    reloadMessages();
  });

  document.getElementById("disable-all").addEventListener("click", () => {
    visibleUsers.clear();
    visibleUsers.add(currentUser); // Only self visible
    reloadMessages();
  });

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
