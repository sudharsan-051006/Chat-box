{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Room</title>

  <!-- Bootstrap + FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.1/css/all.css">

<style>

/* ‚úÖ THEME: DARK MODE (default) */
body.dark-mode {
  background: rgb(69, 68, 68);
}
body.dark-mode #chat-messages {
  background: black;
  color: white;
}
body.dark-mode .system { color: #aaa; }

/* ‚úÖ LIGHT MODE */
body.light-mode {
  background: #f8f9fa;
}
body.light-mode #chat-messages {
  background: white;
  color: black;
}
body.light-mode .system { color: #666; }

/* ‚úÖ Chat container */
#chat-messages {
  height: 65vh;
  overflow-y: auto;
  padding: 2rem 1rem 1rem 1rem;
  border-radius: .5rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
}

/* ‚úÖ System message */
.system {
  align-self: center;
  font-style: italic;
  background: rgba(255,255,255,0.05);
  padding: 0.4rem 1rem;
  border-radius: 8px;
}

/* ‚úÖ Your Messages (Right side) */
.me {
  align-self: flex-end;
  background: linear-gradient(135deg, #007bff, #00b4ff);
  color: #fff;
  border-radius: 1.2rem 1.2rem 0 1.2rem;
  padding: 0.6rem 1rem;
  text-align: right;
  max-width: 75%;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
  word-break: break-word;
  animation: popIn 0.2s ease-in-out;
  position: relative;
}

/* ‚úÖ Others' Messages (Left side) */
.other {
  align-self: flex-start;
  background: #e9ecef;
  color: #212529;
  border-radius: 1.2rem 1.2rem 1.2rem 0;
  padding: 0.6rem 1rem;
  max-width: 75%;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  word-break: break-word;
  animation: popIn 0.2s ease-in-out;
  position: relative;
}

/* ‚úÖ Bubble tails */
.me::after {
  content: "";
  position: absolute;
  right: -6px;
  bottom: 0;
  width: 12px;
  height: 12px;
  background: linear-gradient(135deg, #007bff, #00b4ff);
  clip-path: polygon(0 0, 100% 100%, 0 100%);
}
.other::after {
  content: "";
  position: absolute;
  left: -6px;
  bottom: 0;
  width: 12px;
  height: 12px;
  background: #e9ecef;
  clip-path: polygon(100% 0, 0 100%, 100% 100%);
}

/* ‚úÖ Timestamp */
.message-time {
  display: block;
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.8);
  margin-top: 3px;
  text-align: right;
}
.other .message-time { color: rgba(0, 0, 0, 0.5); }

/* ‚úÖ Pop animation */
@keyframes popIn {
  from { opacity: 0; transform: scale(0.95) translateY(5px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

/* ‚úÖ Mobile adjustments */
@media (max-width: 768px) {
  #chat-messages { height: 60vh; }
  .message { max-width: 85%; font-size: 0.95rem; }
}
</style>
</head>

<body class="dark-mode">
<div class="container my-4 position-relative">

  <!-- ‚öôÔ∏è Dashboard -->
  <div class="dropdown position-absolute" style="top:10px; right:10px; z-index:15;">
    <button class="btn btn-sm dropdown-toggle" type="button"
            id="settingsDropdown" data-bs-toggle="dropdown"
            style="color: turquoise;background-color: #666;" aria-expanded="false">
      <i class="fa-solid fa-table-columns"></i> Dashboard
    </button>

    <ul class="dropdown-menu dropdown-menu-end">
      <li><a class="dropdown-item" href="/password_change/">Change Password</a></li>
      {% if request.user.username == room.created_by.username %}
      <li>
        <button id="lock-toggle-btn" class="dropdown-item text-warning" data-room="{{ room.name }}">
          {% if room.is_locked %} üîì Unlock Room {% else %} üîí Lock Room {% endif %}
        </button>
      </li>
      {% endif %}
      <li><button class="dropdown-item" id="toggle-theme-btn">üåô Night Mode</button></li>
      <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
      <li>
        <button class="dropdown-item" type="button"
                data-bs-toggle="offcanvas" data-bs-target="#offcanvasUsers">
          Online Users
        </button>
      </li>
      <li><button class="dropdown-item text-danger" id="leave-room-btn">üö™ Leave Room</button></li>
    </ul>
  </div>

  <br><br><br><br>

  <h3 style="color: #e9ecef; display:inline-block;" class="btn btn-primary">
    {{ room_name }} {% if room.is_locked %} ‚õìÔ∏è {% endif %}
  </h3>

  <button id="likeButton" class="btn btn-primary">
    <i class="fa-solid fa-thumbs-up"></i><span id="likeCount"> 0</span>
  </button>
  <button id="dilikeButton" class="btn btn-danger">
    <i class="fa-solid fa-thumbs-down"></i><span id="dislikeCount"> 0</span>
  </button>

  <!-- Chat Area -->
  <div id="chat-messages" class="position-relative"></div>

  <!-- Input -->
  <form id="chat-form" class="mt-3 d-flex">
    {% csrf_token %}
    <textarea id="chat-message-input" rows="2" class="form-control me-2"
              placeholder="Type a message..." autocomplete="off"></textarea>
    <button class="btn btn-primary" id="chat-message-submit" type="submit">Send</button>
  </form>
</div>

<!-- Sidebar: Online users -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasUsers">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="online-users-title">Online Users (0)</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <ul id="online-users" class="list-group"></ul>
  </div>
</div>

<script>
/* ------------------ WEBSOCKET CHAT ------------------ */
const roomName = "{{ room_name }}";
const ws_scheme = location.protocol === "https:" ? "wss" : "ws";
const chatSocket = new WebSocket(ws_scheme + '://' + location.host + '/ws/chat/' + roomName + '/');
const chatMessages = document.getElementById("chat-messages");
const chatForm = document.getElementById("chat-form");
const inputField = document.getElementById("chat-message-input");
const currentUser = "{{ request.user.username }}";

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2,'0') + ":" +
                  now.getMinutes().toString().padStart(2,'0');

  if (data.type === "user_list") {
    const onlineUsers = document.getElementById("online-users");
    const onlineUsersTitle = document.getElementById("online-users-title");
    onlineUsers.innerHTML = "";
    data.users.forEach(u => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = u;
      onlineUsers.appendChild(li);
    });
    onlineUsersTitle.textContent = `Online Users (${data.users.length})`;
    return;
  }

  const msg = document.createElement("div");
  if (data.user === "System") {
    msg.className = "system";
    msg.textContent = data.message + " (" + timeStr + ")";
  } else {
    const isMe = data.user.trim().toLowerCase() === currentUser.trim().toLowerCase();
    msg.className = isMe ? "message me" : "message other";
    msg.innerHTML = `<span>${isMe ? data.message : data.user + ": " + data.message}</span>
                     <span class="message-time">${timeStr}</span>`;
  }

  chatMessages.appendChild(msg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
};

chatForm.addEventListener("submit", function(e) {
  e.preventDefault();
  if (inputField.value.trim()) {
    chatSocket.send(JSON.stringify({ "message": inputField.value }));
    inputField.value = "";
  }
});

/* ------------------ LIKE / DISLIKE ------------------ */
let likeCount = 0;
let dislikeCount = 0;
document.getElementById("likeButton").onclick = () => document.getElementById("likeCount").innerText = ++likeCount;
document.getElementById("dilikeButton").onclick = () => document.getElementById("dislikeCount").innerText = ++dislikeCount;

/* ------------------ LEAVE ROOM ------------------ */
document.getElementById("leave-room-btn").onclick = () => {
  if (chatSocket.readyState === WebSocket.OPEN) chatSocket.close();
  location.href = "/";
};

/* ------------------ LOCK / UNLOCK ------------------ */
document.getElementById("lock-toggle-btn")?.addEventListener("click", async function() {
  const roomName = this.dataset.room;
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
  const res = await fetch(`/room/${roomName}/toggle-lock/`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken }
  });
  const data = await res.json();
  const btn = document.getElementById("lock-toggle-btn");
  const roomTitle = document.querySelector("h3");
  if (data.locked) {
    btn.textContent = "üîì Unlock Room";
    if (!roomTitle.innerHTML.includes("‚õìÔ∏è")) roomTitle.innerHTML += " ‚õìÔ∏è";
  } else {
    btn.textContent = "üîí Lock Room";
    roomTitle.innerHTML = roomTitle.innerHTML.replace("‚õìÔ∏è", "").trim();
  }
});

/* ------------------ THEME MODE ------------------ */
const themeBtn = document.getElementById("toggle-theme-btn");
document.body.className = localStorage.getItem("theme") || "dark-mode";
themeBtn.textContent = document.body.classList.contains("dark-mode") ? "üåû Light Mode" : "üåô Night Mode";
themeBtn.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  document.body.classList.toggle("light-mode");
  const isDark = document.body.classList.contains("dark-mode");
  themeBtn.textContent = isDark ? "üåû Light Mode" : "üåô Night Mode";
  localStorage.setItem("theme", isDark ? "dark-mode" : "light-mode");
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
